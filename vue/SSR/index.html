<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>SSR （Server Side Render） | Ace</title>
    <meta name="generator" content="VuePress 1.4.1">
    <link rel="icon" href="/Ace.Blog/logo.png">
    <link rel="manifest" href="/Ace.Blog/manifest.json">
    <link rel="apple-touch-icon" href="/Ace.Blog/icons/apple-touch-icon-152x152.png">
    <link rel="mask-icon" href="/Ace.Blog/icons/safari-pinned-tab.svg" color="#3eaf7c">
    <meta name="description" content="ace blog">
    <meta name="theme-color" content="#3eaf7c">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="msapplication-TileImage" content="/icons/msapplication-icon-144x144.png">
    <meta name="msapplication-TileColor" content="#000000">
    <link rel="preload" href="/Ace.Blog/assets/css/0.styles.d44ed3c7.css" as="style"><link rel="preload" href="/Ace.Blog/assets/js/app.d3974293.js" as="script"><link rel="preload" href="/Ace.Blog/assets/js/2.0968e3c9.js" as="script"><link rel="preload" href="/Ace.Blog/assets/js/17.e20e25f8.js" as="script"><link rel="prefetch" href="/Ace.Blog/assets/js/10.857a411d.js"><link rel="prefetch" href="/Ace.Blog/assets/js/11.bc091e0e.js"><link rel="prefetch" href="/Ace.Blog/assets/js/12.89183f5b.js"><link rel="prefetch" href="/Ace.Blog/assets/js/13.29c68460.js"><link rel="prefetch" href="/Ace.Blog/assets/js/14.8ed1ca88.js"><link rel="prefetch" href="/Ace.Blog/assets/js/15.c158f098.js"><link rel="prefetch" href="/Ace.Blog/assets/js/16.fc8c687e.js"><link rel="prefetch" href="/Ace.Blog/assets/js/18.1698a641.js"><link rel="prefetch" href="/Ace.Blog/assets/js/19.df689c41.js"><link rel="prefetch" href="/Ace.Blog/assets/js/3.fc62896d.js"><link rel="prefetch" href="/Ace.Blog/assets/js/4.4d64059e.js"><link rel="prefetch" href="/Ace.Blog/assets/js/5.a33e5707.js"><link rel="prefetch" href="/Ace.Blog/assets/js/6.8b090542.js"><link rel="prefetch" href="/Ace.Blog/assets/js/7.05f834a2.js"><link rel="prefetch" href="/Ace.Blog/assets/js/8.7dff8a46.js"><link rel="prefetch" href="/Ace.Blog/assets/js/9.a476501b.js">
    <link rel="stylesheet" href="/Ace.Blog/assets/css/0.styles.d44ed3c7.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container no-sidebar"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/Ace.Blog/" class="home-link router-link-active"><!----> <span class="site-name">Ace</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="JS/TS" class="dropdown-title"><span class="title">JS/TS</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/Ace.Blog/TS/Axios/" class="nav-link">
  Axios
</a></li></ul></div></div><div class="nav-item"><a href="/Ace.Blog/DataStructure/DataStructure/" class="nav-link">
  数据结构和算法
</a></div><div class="nav-item"><a href="/Ace.Blog/element/form/" class="nav-link">
  UI 组件
</a></div> <a href="https://github.com/Been101/Ace.Blog" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="JS/TS" class="dropdown-title"><span class="title">JS/TS</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/Ace.Blog/TS/Axios/" class="nav-link">
  Axios
</a></li></ul></div></div><div class="nav-item"><a href="/Ace.Blog/DataStructure/DataStructure/" class="nav-link">
  数据结构和算法
</a></div><div class="nav-item"><a href="/Ace.Blog/element/form/" class="nav-link">
  UI 组件
</a></div> <a href="https://github.com/Been101/Ace.Blog" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav>  <!----> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="ssr-（server-side-render）"><a href="#ssr-（server-side-render）" class="header-anchor">#</a> SSR （Server Side Render）</h1> <p>服务端将Vue组件渲染为HTML 字符串，并将html字符串直接发送到浏览器，最后将这些静态标记&quot;激活&quot;为客户端上完全可交互的应用程序。</p> <h2 id="优点"><a href="#优点" class="header-anchor">#</a> 优点</h2> <ul><li>更好的SEO， 由于搜索引擎爬虫抓取工具可以直接查看完全渲染的页面</li> <li>更快的内容到达时间</li></ul> <h2 id="缺点"><a href="#缺点" class="header-anchor">#</a> 缺点</h2> <ul><li>开发条件受限。 （服务端只执行beforeCreated 和 created 生命周期函数， 并且没有window, DOM, BOM等）。</li> <li>涉及构建设置和部署的更多要求，需要处于node server的运行环境</li> <li>更多的服务端负载</li></ul> <h2 id="ssr精髓"><a href="#ssr精髓" class="header-anchor">#</a> SSR精髓</h2> <ul><li>服务端将Vue组件渲染为HTML 字符串，并将html字符串直接发送到浏览器</li> <li>独立的应用程序实例，以便不会有交叉请求造成的状态污染</li></ul> <h2 id="大致分为一下几种情况"><a href="#大致分为一下几种情况" class="header-anchor">#</a> 大致分为一下几种情况</h2> <ul><li>直接将Vue 组件渲染为html字符串并返回给浏览器</li> <li>不同路由下返回不同的页面</li> <li>Vue组件中初始化时含有异步请求</li> <li>一个完整的Vue SSR(包括Vue Router, axios, Vuex)</li></ul> <h2 id="先创建一个简单的vue项目-代码地址-01"><a href="#先创建一个简单的vue项目-代码地址-01" class="header-anchor">#</a> 先创建一个简单的vue项目 <a href="https://github.com/Been101/Vue.SSR/tree/master/01" target="_blank" rel="noopener noreferrer">代码地址 01<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></h2> <div class="language- extra-class"><pre class="language-text"><code>|—— components  //  子组件
|   |—— Foo.vue   
|   |—— Bar.vue
|   
|—— App.vue    // 根组件
|—— index.js   // 入口文件
|—— webpack.config.js
</code></pre></div><p>代码很简单就是一个很普通的vue项目。(包括一些点击事件，数据绑定)</p> <h2 id="直接渲染vue-组件成html-字符串并返回-代码地址-02-demos"><a href="#直接渲染vue-组件成html-字符串并返回-代码地址-02-demos" class="header-anchor">#</a> 直接渲染Vue 组件成html 字符串并返回 <a href="https://github.com/Been101/Vue.SSR/tree/master/02" target="_blank" rel="noopener noreferrer">代码地址 02/demos<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></h2> <p>官方提供一个插件 vue-server-renderer 可以直接将vue 实例渲染成 Dom 标记</p> <h3 id="demo1"><a href="#demo1" class="header-anchor">#</a> demo1</h3> <div class="language-js extra-class"><pre class="language-js"><code>   <span class="token keyword">const</span> Vue <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'vue'</span><span class="token punctuation">)</span>
   <span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Vue</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
     template<span class="token punctuation">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">&lt;div&gt;Hello World&lt;/div&gt;</span><span class="token template-punctuation string">`</span></span>
   <span class="token punctuation">}</span><span class="token punctuation">)</span>
   
   <span class="token comment">// 第 2 步：创建一个 renderer</span>
   <span class="token keyword">const</span> renderer <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'vue-server-renderer'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">createRenderer</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
   
   <span class="token comment">// 第 3 步：将 Vue 实例渲染为 HTML</span>
   renderer<span class="token punctuation">.</span><span class="token function">renderToString</span><span class="token punctuation">(</span>app<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> html</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
     <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token keyword">throw</span> err
     console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>html<span class="token punctuation">)</span>
     <span class="token comment">// =&gt; &lt;div data-server-rendered=&quot;true&quot;&gt;Hello World&lt;/div&gt;</span>
   <span class="token punctuation">}</span><span class="token punctuation">)</span>
   
   <span class="token comment">// 在 2.5.0+，如果没有传入回调函数，则会返回 Promise：</span>
   renderer<span class="token punctuation">.</span><span class="token function">renderToString</span><span class="token punctuation">(</span>app<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">html</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
     console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>html<span class="token punctuation">)</span>
   <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token parameter">err</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
     console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
   <span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><h3 id="demo2"><a href="#demo2" class="header-anchor">#</a> demo2</h3> <p>与服务端结合， 通过请求返回html 页面</p> <div class="language-js extra-class"><pre class="language-js"><code>   <span class="token keyword">const</span> Vue <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'vue'</span><span class="token punctuation">)</span>
   <span class="token keyword">const</span> Koa <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'koa'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token keyword">const</span> Router <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'koa-router'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token keyword">const</span> renderer <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'vue-server-renderer'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">createRenderer</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
   
   <span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Koa</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token keyword">const</span> router <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Router</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   
   router<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'*'</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">ctx<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
     <span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Vue</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
       data<span class="token punctuation">:</span> <span class="token punctuation">{</span>
         url<span class="token punctuation">:</span> ctx<span class="token punctuation">.</span>request<span class="token punctuation">.</span>url
       <span class="token punctuation">}</span><span class="token punctuation">,</span>
       template<span class="token punctuation">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">&lt;div&gt;访问的 URL 是： {{ url }}&lt;/div&gt;</span><span class="token template-punctuation string">`</span></span>
     <span class="token punctuation">}</span><span class="token punctuation">)</span>
   
     renderer<span class="token punctuation">.</span><span class="token function">renderToString</span><span class="token punctuation">(</span>app<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> html</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
       <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
         ctx<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token string">'Internal Server Error'</span><span class="token punctuation">)</span>
         <span class="token keyword">return</span>
       <span class="token punctuation">}</span>
       ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
         &lt;!DOCTYPE html&gt;
         &lt;html lang=&quot;en&quot;&gt;
           &lt;head&gt;&lt;title&gt;Hello&lt;/title&gt;&lt;/head&gt;
           &lt;body&gt;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>html<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&lt;/body&gt;
         &lt;/html&gt;
       </span><span class="token template-punctuation string">`</span></span>
     <span class="token punctuation">}</span><span class="token punctuation">)</span>
   <span class="token punctuation">}</span><span class="token punctuation">)</span>
   
   app
     <span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>router<span class="token punctuation">.</span><span class="token function">routes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
     <span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>router<span class="token punctuation">.</span><span class="token function">allowedMethods</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   app<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">8080</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
     console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'listen 8080'</span><span class="token punctuation">)</span>
   <span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>从demo1 可以看出vue-server-renderer 方法返回的是一个html 片段 官方叫标记（markup）， 并不是完整的html 页面。
我们必须像demo2中那样用一个额外的 HTML 页面包裹容器，来包裹生成的 HTML 标记。</p> <p>我们可以提供一个模板页面。例如</p> <div class="language-html extra-class"><pre class="language-html"><code><span class="token doctype">&lt;!DOCTYPE html&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span> <span class="token attr-name">lang</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>en<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
 <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>title</span><span class="token punctuation">&gt;</span></span>Hello<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>title</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">&gt;</span></span>
 <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">&gt;</span></span>
   <span class="token comment">&lt;!--vue-ssr-outlet--&gt;</span>  
 <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>注意 <code>&lt;!--vue-ssr-outlet--&gt;</code> 注释这里将是应用程序 HTML 标记注入的地方。 这是插件提供的，如果不用  <code>&lt;!--vue-ssr-outlet--&gt;</code>也是可以的，那就要自己去简单处理一下了。</p> <h3 id="demo3"><a href="#demo3" class="header-anchor">#</a> demo3</h3> <div class="language-html extra-class"><pre class="language-html"><code> <span class="token doctype">&lt;!DOCTYPE html&gt;</span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span> <span class="token attr-name">lang</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>en<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
     <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>title</span><span class="token punctuation">&gt;</span></span>Hello<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>title</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">&gt;</span></span>
     <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">&gt;</span></span>
       {injectHere}
     <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">&gt;</span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><h4 id="demo3-js"><a href="#demo3-js" class="header-anchor">#</a> demo3.js</h4> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> template <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">readFileSync</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'./index.template.html'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">'utf-8'</span><span class="token punctuation">)</span>
ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> template<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token string">'{injectHere}'</span><span class="token punctuation">,</span> html<span class="token punctuation">)</span>
</code></pre></div><h3 id="需要注意几点："><a href="#需要注意几点：" class="header-anchor">#</a> 需要注意几点：</h3> <ul><li>服务器渲染的 Vue.js 应用程序也可以被认为是&quot;同构&quot;或&quot;通用&quot;，因为应用程序的大部分代码都可以在服务器和客户端上运行。</li> <li>在纯客户端应用程序 (client-only app) 中，每个用户会在他们各自的浏览器中使用新的应用程序实例。对于服务器端渲染，我们也希望如此：每个请求应该都是全新的、独立的应用程序实例，以便不会有交叉请求造成的状态污染 (cross-request state pollution)</li></ul> <h4 id="对于第一点"><a href="#对于第一点" class="header-anchor">#</a> 对于第一点:</h4> <ul><li><p>既然在客户端和服务端上都能运行，那应该有两个入口文件。一些 Dom, Bom 的操作在服务端肯定是不行的.</p></li> <li><p>通常 Vue 应用程序是由 webpack 和 vue-loader 构建，并且许多 webpack 特定功能不能直接在 Node.js 中运行（例如通过 file-loader 导入文件，通过 css-loader 导入 CSS）</p></li></ul> <h4 id="对于第二点："><a href="#对于第二点：" class="header-anchor">#</a> 对于第二点：</h4> <ul><li>需要将其包装为一个工厂函数，每次调用都会生成一个全新的根组件</li></ul> <p>app.js</p> <div class="language-js extra-class"><pre class="language-js"><code>    <span class="token keyword">import</span> Vue <span class="token keyword">from</span> <span class="token string">'vue'</span>
    <span class="token keyword">import</span> App <span class="token keyword">from</span> <span class="token string">'./App.vue'</span>
    
    <span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">createApp</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Vue</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
            <span class="token function-variable function">render</span><span class="token punctuation">:</span> <span class="token parameter">h</span> <span class="token operator">=&gt;</span> <span class="token function">h</span><span class="token punctuation">(</span>App<span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token punctuation">{</span> app <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre></div><p>enter-client.js</p> <div class="language-js extra-class"><pre class="language-js"><code>    <span class="token keyword">import</span> <span class="token punctuation">{</span> createApp <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./app.js'</span>
    
    <span class="token keyword">const</span> <span class="token punctuation">{</span> app <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">createApp</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    
    <span class="token comment">// App.vue 模板中根元素具有 `id=&quot;app&quot;`</span>
    app<span class="token punctuation">.</span><span class="token function">$mount</span><span class="token punctuation">(</span><span class="token string">'#app'</span><span class="token punctuation">)</span>
</code></pre></div><p>enter-server.js</p> <div class="language-js extra-class"><pre class="language-js"><code>    <span class="token keyword">import</span> <span class="token punctuation">{</span> createApp <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./app.js'</span><span class="token punctuation">;</span>
    
    <span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token parameter">context</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span> <span class="token comment">// koa 的 context</span>
        <span class="token keyword">const</span> <span class="token punctuation">{</span> app <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">createApp</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> app
    <span class="token punctuation">}</span>
</code></pre></div><div class="language-html extra-class"><pre class="language-html"><code>    <span class="token doctype">&lt;!DOCTYPE html&gt;</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span> <span class="token attr-name">lang</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>en<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">charset</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>UTF-8<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>viewport<span class="token punctuation">&quot;</span></span> <span class="token attr-name">content</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>width=device-width, initial-scale=1.0<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">http-equiv</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>X-UA-Compatible<span class="token punctuation">&quot;</span></span> <span class="token attr-name">content</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>ie=edge<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>title</span><span class="token punctuation">&gt;</span></span>服务端渲染<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>title</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">&gt;</span></span>
      <span class="token comment">&lt;!--vue-ssr-outlet--&gt;</span>
      <span class="token comment">&lt;!-- 引入客户端打包后的js文件(client.bundle.js) --&gt;</span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>text/javascript<span class="token punctuation">&quot;</span></span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>&lt;%= htmlWebpackPlugin.options.files.js %&gt;<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>webpack.server.config.js</p> <div class="language-js extra-class"><pre class="language-js"><code>    <span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'path'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> merge <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'webpack-merge'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> HtmlWebpackPlugin <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'html-webpack-plugin'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> base <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./webpack.base.config'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token function">merge</span><span class="token punctuation">(</span>base<span class="token punctuation">,</span> <span class="token punctuation">{</span>
        <span class="token comment">// 这允许 webpack 以 Node 适用方式(Node-appropriate fashion)处理动态导入(dynamic import)，</span>
        <span class="token comment">// 并且还会在编译 Vue 组件时，</span>
        <span class="token comment">// 告知 `vue-loader` 输送面向服务器代码(server-oriented code)。</span>
      target<span class="token punctuation">:</span> <span class="token string">'node'</span><span class="token punctuation">,</span>
      entry<span class="token punctuation">:</span> <span class="token punctuation">{</span>
        server<span class="token punctuation">:</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'../entry-server.js'</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      output<span class="token punctuation">:</span> <span class="token punctuation">{</span>
          <span class="token comment">// 此处告知 server bundle 使用 Node 风格导出模块(Node-style exports)</span>
        libraryTarget<span class="token punctuation">:</span> <span class="token string">'commonjs2'</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      plugins<span class="token punctuation">:</span> <span class="token punctuation">[</span>
        <span class="token keyword">new</span> <span class="token class-name">HtmlWebpackPlugin</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
          template<span class="token punctuation">:</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'../../index.ssr.html'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
          filename<span class="token punctuation">:</span> <span class="token string">'index.ssr.html'</span><span class="token punctuation">,</span>
          files<span class="token punctuation">:</span> <span class="token punctuation">{</span>
            js<span class="token punctuation">:</span> <span class="token string">'client.bundle.js'</span> <span class="token comment">// index.ssr.html 中引入的js文件是客户端打包出来的client.bundle.js。这是因为 Vue 需要在浏览器端接管由服务端发送的静态 HTML，使其变为由 Vue 管理的动态 DOM。这个过程官方称为客户端激活</span>
          <span class="token punctuation">}</span><span class="token punctuation">,</span>
          excludeChunks<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">'server'</span><span class="token punctuation">]</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token punctuation">]</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>webpack.cliient.config.js</p> <div class="language-js extra-class"><pre class="language-js"><code>    <span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'path'</span><span class="token punctuation">)</span>
    <span class="token keyword">const</span> merge <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'webpack-merge'</span><span class="token punctuation">)</span>
    <span class="token keyword">const</span> HtmlWebpackPlugin <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'html-webpack-plugin'</span><span class="token punctuation">)</span>
    <span class="token keyword">const</span> base <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./webpack.base.config'</span><span class="token punctuation">)</span>
    
    module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token function">merge</span><span class="token punctuation">(</span>base<span class="token punctuation">,</span> <span class="token punctuation">{</span>
        entry<span class="token punctuation">:</span> <span class="token punctuation">{</span>
            client<span class="token punctuation">:</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'../entry-client.js'</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        plugins<span class="token punctuation">:</span> <span class="token punctuation">[</span>
            <span class="token keyword">new</span> <span class="token class-name">HtmlWebpackPlugin</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
                template<span class="token punctuation">:</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'../../index.html'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                filename<span class="token punctuation">:</span> <span class="token string">'index.html'</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token punctuation">]</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>这是比较完整的 客户端接管由服务端渲染Vue 实例发送的静态 HTML，并由 Vue 管理的动态Dom 的例子。<a href="https://github.com/Been101/Vue.SSR/tree/master/03" target="_blank" rel="noopener noreferrer">完整代码 03<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <h2 id="引入路由router-的服务端渲染"><a href="#引入路由router-的服务端渲染" class="header-anchor">#</a> 引入路由router 的服务端渲染</h2> <p>Vue 项目的路由管理由vue-router 来负责，和 02 项目一样， 服务端返回渲染后的html, 剩下的就交给Vue了。</p> <p>router.js</p> <div class="language-js extra-class"><pre class="language-js"><code>    <span class="token keyword">import</span> Vue <span class="token keyword">from</span> <span class="token string">'vue'</span>
    <span class="token keyword">import</span> Router <span class="token keyword">from</span> <span class="token string">'vue-router'</span>
    <span class="token keyword">import</span> Bar <span class="token keyword">from</span> <span class="token string">&quot;./components/Bar.vue&quot;</span><span class="token punctuation">;</span>
    <span class="token keyword">import</span> Foo <span class="token keyword">from</span> <span class="token string">&quot;./components/Foo.vue&quot;</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> routes <span class="token operator">=</span> <span class="token punctuation">[</span>
      <span class="token punctuation">{</span> path<span class="token punctuation">:</span> <span class="token string">'/foo'</span><span class="token punctuation">,</span> component<span class="token punctuation">:</span> Foo <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token punctuation">{</span> path<span class="token punctuation">:</span> <span class="token string">'/bar'</span><span class="token punctuation">,</span> component<span class="token punctuation">:</span> Bar <span class="token punctuation">}</span>
    <span class="token punctuation">]</span>
    
    Vue<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>Router<span class="token punctuation">)</span>
    
    <span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">createRouter</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 创建 router 实例，然后传 `routes` 配置</span>
      <span class="token comment">// 你还可以传别的配置参数, 不过先这么简单着吧。</span>
      <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Router</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        mode<span class="token punctuation">:</span> <span class="token string">'history'</span><span class="token punctuation">,</span>
        routes
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
</code></pre></div><p>app.js 引入router</p> <div class="language-js extra-class"><pre class="language-js"><code>    <span class="token keyword">import</span> Vue <span class="token keyword">from</span> <span class="token string">'vue'</span>
    <span class="token keyword">import</span> App <span class="token keyword">from</span> <span class="token string">'./App.vue'</span>
    <span class="token keyword">import</span> <span class="token punctuation">{</span> createRouter <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./router'</span>
    
    <span class="token comment">// 导出一个工厂函数，用于创建新的</span>
    <span class="token comment">// 应用程序、router 和 store 实例</span>
    <span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">createApp</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 创建 router 实例</span>
        <span class="token keyword">const</span> router <span class="token operator">=</span> <span class="token function">createRouter</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Vue</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
            <span class="token comment">// 注入 router 到根 Vue 实例</span>
            router<span class="token punctuation">,</span>
            <span class="token comment">// 根实例简单的渲染应用程序组件。</span>
            <span class="token function-variable function">render</span><span class="token punctuation">:</span> <span class="token parameter">h</span> <span class="token operator">=&gt;</span> <span class="token function">h</span><span class="token punctuation">(</span>App<span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token punctuation">{</span> app<span class="token punctuation">,</span> router <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre></div><p>这样就可以了码， 显然还不够，Vue 优化上，我们一般会选择惰性加载组件，而不是一下子全部加载。那我们就需要简单修改一下entry-server.js 和 router.js 文件了。</p> <p>router.js</p> <div class="language-js extra-class"><pre class="language-js"><code>    <span class="token keyword">import</span> Vue <span class="token keyword">from</span> <span class="token string">'vue'</span>
    <span class="token keyword">import</span> Router <span class="token keyword">from</span> <span class="token string">'vue-router'</span>
    
    <span class="token keyword">const</span> routes <span class="token operator">=</span> <span class="token punctuation">[</span>
     <span class="token comment">// webpack.base.config.js 中需要配置 @babel/plugin-syntax-dynamic-import</span>
      <span class="token punctuation">{</span> path<span class="token punctuation">:</span> <span class="token string">'/foo'</span><span class="token punctuation">,</span> <span class="token function-variable function">component</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">import</span><span class="token punctuation">(</span><span class="token string">'./components/Foo.vue'</span><span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> 
      <span class="token punctuation">{</span> path<span class="token punctuation">:</span> <span class="token string">'/bar'</span><span class="token punctuation">,</span> <span class="token function-variable function">component</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">import</span><span class="token punctuation">(</span><span class="token string">'./components/Bar.vue'</span><span class="token punctuation">)</span> <span class="token punctuation">}</span>
    <span class="token punctuation">]</span>
    
    Vue<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>Router<span class="token punctuation">)</span>
    
    <span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">createRouter</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 创建 router 实例，然后传 `routes` 配置</span>
      <span class="token comment">// 你还可以传别的配置参数, 不过先这么简单着吧。</span>
      <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Router</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        mode<span class="token punctuation">:</span> <span class="token string">'history'</span><span class="token punctuation">,</span>
        routes
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
</code></pre></div><p>由于加入了异步路由钩子函数或组件，所以我们将返回一个 Promise，以便服务器能够等待所有的内容在渲染前，就已经准备就绪。
我们现在的entry-server.js 更新成这样</p> <p>entry-server.js</p> <div class="language-js extra-class"><pre class="language-js"><code>    <span class="token keyword">import</span> <span class="token punctuation">{</span> createApp <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./app.js'</span><span class="token punctuation">;</span>
    
    <span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token parameter">context</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token comment">// 因为有可能会是异步路由钩子函数或组件，所以我们将返回一个 Promise，</span>
        <span class="token comment">// 以便服务器能够等待所有的内容在渲染前，</span>
        <span class="token comment">// 就已经准备就绪。</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            <span class="token keyword">const</span> <span class="token punctuation">{</span> app<span class="token punctuation">,</span> router <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">createApp</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>context<span class="token punctuation">.</span>url<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">'.'</span><span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 防止匹配 favicon.ico   *.js 文件</span>
                router<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span>url<span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
            <span class="token comment">// 设置服务器端 router 的位置</span>
    
            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span>url<span class="token punctuation">,</span> <span class="token string">'******'</span><span class="token punctuation">)</span>
            <span class="token comment">// 等到 router 将可能的异步组件和钩子函数解析完</span>
            router<span class="token punctuation">.</span><span class="token function">onReady</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                <span class="token keyword">const</span> matchedComponents <span class="token operator">=</span> router<span class="token punctuation">.</span><span class="token function">getMatchedComponents</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token comment">// 匹配不到的路由，执行 reject 函数，并返回 404</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>matchedComponents<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">return</span> <span class="token function">reject</span><span class="token punctuation">(</span><span class="token punctuation">{</span> code<span class="token punctuation">:</span> <span class="token number">404</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
                <span class="token punctuation">}</span>
    
                <span class="token comment">// Promise 应该 resolve 应用程序实例，以便它可以渲染</span>
                <span class="token function">resolve</span><span class="token punctuation">(</span>app<span class="token punctuation">)</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span> reject<span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
</code></pre></div><p>entry.client.js</p> <div class="language-js extra-class"><pre class="language-js"><code>    <span class="token keyword">import</span> <span class="token punctuation">{</span> createApp <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./app.js'</span>
    
    <span class="token keyword">const</span> <span class="token punctuation">{</span> app<span class="token punctuation">,</span> router <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">createApp</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    
    router<span class="token punctuation">.</span><span class="token function">onReady</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token comment">// 这里假定 App.vue 模板中根元素具有 `id=&quot;app&quot;`</span>
      app<span class="token punctuation">.</span><span class="token function">$mount</span><span class="token punctuation">(</span><span class="token string">'#app'</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>由于用到了，异步路由这个时候，打包的bundle.js不包括异步组件的js文件。还按照上面直接引入 server.bundle.js 的话，会报错找不到相关的异步组件的js文件。</p> <p>所以这里我们用vue-server-renderer下的插件vue-server-renderer/server-plugin把server.entry.js文件打包成一个json 文件， 而json 文件中会把所有的异步组件和相关的js一一map。</p> <h2 id="需要初始化数据的服务端渲染"><a href="#需要初始化数据的服务端渲染" class="header-anchor">#</a> 需要初始化数据的服务端渲染</h2> <p>在服务器端渲染(SSR)期间，我们本质上是在渲染我们应用程序的&quot;快照&quot;，所以如果应用程序依赖于一些异步数据，那么在开始渲染过程之前，需要先预取和解析好这些数据。</p> <p>另一个需要关注的问题是在客户端，在挂载 (mount) 到客户端应用程序之前，需要获取到与服务器端应用程序完全相同的数据 - 否则，客户端应用程序会因为使用与服务器端应用程序不同的状态，然后导致混合失败。</p> <p>为了解决这个问题，获取的数据需要位于视图组件之外，即放置在专门的数据预取存储容器(data store)或&quot;状态容器(state container)）&quot;中。首先，在服务器端，我们可以在渲染之前预取数据，并将数据填充到 store 中。此外，我们将在 HTML 中序列化(serialize)和内联预置(inline)状态。这样，在挂载(mount)到客户端应用程序之前，可以直接从 store 获取到内联预置(inline)状态。</p> <p>我们用官方的状态管理库 的VueX 。</p> <p>store.js</p> <div class="language-js extra-class"><pre class="language-js"><code>    <span class="token keyword">import</span> Vue <span class="token keyword">from</span> <span class="token string">'vue'</span>
    <span class="token keyword">import</span> Vuex <span class="token keyword">from</span> <span class="token string">'vuex'</span>
    
    Vue<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>Vuex<span class="token punctuation">)</span>
    
    <span class="token comment">// 一个可以返回 Promise 的 API</span>
    <span class="token keyword">import</span> <span class="token punctuation">{</span> fetchItem <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./api'</span>
    
    <span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">createStore</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Vuex<span class="token punctuation">.</span>Store</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        state<span class="token punctuation">:</span> <span class="token punctuation">{</span>
          items<span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        actions<span class="token punctuation">:</span> <span class="token punctuation">{</span>
          <span class="token function">fetchItem</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> commit <span class="token punctuation">}</span><span class="token punctuation">,</span> id</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// `store.dispatch()` 会返回 Promise，</span>
            <span class="token comment">// 以便我们能够知道数据在何时更新</span>
            <span class="token keyword">return</span> <span class="token function">fetchItem</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">item</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
              <span class="token function">commit</span><span class="token punctuation">(</span><span class="token string">'setItem'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> id<span class="token punctuation">,</span> item <span class="token punctuation">}</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        mutations<span class="token punctuation">:</span> <span class="token punctuation">{</span>
          <span class="token function">setItem</span> <span class="token punctuation">(</span><span class="token parameter">state<span class="token punctuation">,</span> <span class="token punctuation">{</span> id<span class="token punctuation">,</span> item <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            Vue<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>state<span class="token punctuation">.</span>items<span class="token punctuation">,</span> id<span class="token punctuation">,</span> item<span class="token punctuation">)</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
</code></pre></div><p>app.js</p> <div class="language-js extra-class"><pre class="language-js"><code>    <span class="token keyword">import</span> Vue <span class="token keyword">from</span> <span class="token string">'vue'</span>
    <span class="token keyword">import</span> App <span class="token keyword">from</span> <span class="token string">'./App.vue'</span>
    <span class="token keyword">import</span> <span class="token punctuation">{</span> createRouter <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./router'</span>
    <span class="token keyword">import</span> <span class="token punctuation">{</span> createStore <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./store'</span>
    
    <span class="token comment">// 导出一个工厂函数，用于创建新的</span>
    <span class="token comment">// 应用程序、router 和 store 实例</span>
    <span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">createApp</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> router <span class="token operator">=</span> <span class="token function">createRouter</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">const</span> store <span class="token operator">=</span> <span class="token function">createStore</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Vue</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
            router<span class="token punctuation">,</span>
            store<span class="token punctuation">,</span>
            <span class="token comment">// 根实例简单的渲染应用程序组件。</span>
            <span class="token function-variable function">render</span><span class="token punctuation">:</span> <span class="token parameter">h</span> <span class="token operator">=&gt;</span> <span class="token function">h</span><span class="token punctuation">(</span>App<span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token punctuation">{</span> app<span class="token punctuation">,</span> router<span class="token punctuation">,</span> store <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre></div><p>那么，我们在哪里放置「dispatch 数据预取 action」的代码？</p> <p>我们需要通过访问路由，来决定获取哪部分数据 - 这也决定了哪些组件需要渲染。事实上，给定路由所需的数据，也是在该路由上渲染组件时所需的数据。所以在路由组件中放置数据预取逻辑，是很自然的事情。</p> <p>我们将在路由组件上暴露出一个自定义静态函数 asyncData。注意，由于此函数会在组件实例化之前调用，所以它无法访问 this。需要将 store 和路由信息作为参数传递进去：</p></div> <footer class="page-edit"><div class="edit-link"><a href="https://github.com/Been101/Ace.Blog/edit/master/src/docs/vue/SSR/index.md" target="_blank" rel="noopener noreferrer">在 GitHub 上编辑此页</a> <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></div> <div class="last-updated"><span class="prefix">上次更新:</span> <span class="time">11/6/2019, 10:30:58 PM</span></div></footer> <!----> </main></div><div class="global-ui"></div></div>
    <script src="/Ace.Blog/assets/js/app.d3974293.js" defer></script><script src="/Ace.Blog/assets/js/2.0968e3c9.js" defer></script><script src="/Ace.Blog/assets/js/17.e20e25f8.js" defer></script>
  </body>
</html>
